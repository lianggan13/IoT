C51 COMPILER V9.54   DS18B20                                                               06/03/2024 17:19:36 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Objects\DS18B20.obj
COMPILER INVOKED BY: D:\App\Keil_v5\C51\BIN\C51.EXE Temp\DS18B20.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRI
                    -NT(.\Listings\DS18B20.lst) TABS(2) OBJECT(.\Objects\DS18B20.obj)

line level    source

   1          #include <reg52.h>
   2          #include "DS18B20.h"
   3          #include "../Utility/delay.h"
   4          #include "../Utility/CommData.h"
   5          #include "../LED/DynamicLed.h"
   6          
   7          typedef unsigned int u16; // å¯¹æ•°æ®ç±»å‹è¿›è¡Œå£°æ˜å®šä¹‰
   8          typedef unsigned char u8;
   9          
  10          #ifndef uchar
  11          #define uchar unsigned char
  12          #endif
  13          
  14          #ifndef uint
  15          #define uint unsigned int
  16          #endif
  17          
  18          sbit DSPORT = P3 ^ 7;
  19          
  20          u8 DisplayData[8];
  21          
  22          /*******************************************************************************
  23           * å‡½ æ•° å         : Delay1ms
  24           * å‡½æ•°åŠŸèƒ½      : å»¶æ—¶å‡½æ•°
  25           * è¾“    å…¥         : æ— 
  26           * è¾“    å‡º         : æ— 
  27           *******************************************************************************/
  28          
  29          void Delay1ms(uint y)
  30          {
  31   1          uint x;
  32   1          for (; y > 0; y--)
  33   1          {
  34   2              for (x = 110; x > 0; x--)
  35   2                  ;
  36   2          }
  37   1      }
  38          /*******************************************************************************
  39           * å‡½ æ•° å         : Ds18b20Init
  40           * å‡½æ•°åŠŸèƒ½      : åˆå§‹åŒ–
  41           * è¾“    å…¥         : æ— 
  42           * è¾“    å‡º         : åˆå§‹åŒ–æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0
  43           *******************************************************************************/
  44          uchar Ds18b20Init()
  45          {
  46   1          uchar i;
  47   1          DSPORT = 0; // å°†æ€»çº¿æ‹‰ä½480us~960us
  48   1          i = 70;
  49   1          while (i--)
  50   1              ;       // å»¶æ—¶642us
  51   1          DSPORT = 1; // ç„¶åæ‹‰é«˜æ€»çº¿ï¼Œå¦‚æœDS18B20åšå‡ºååº”ä¼šå°†åœ¨15us~60usåæ€»çº¿æ‹‰ä½
  52   1          i = 0;
  53   1          while (DSPORT) // ç­‰å¾…DS18B20æ‹‰ä½æ€»çº¿ è‡³å°‘ 60us
  54   1          {
C51 COMPILER V9.54   DS18B20                                                               06/03/2024 17:19:36 PAGE 2   

  55   2              Delay1ms(1);
  56   2              i++;
  57   2              if (i > 5) // ç­‰å¾…>5MS
  58   2              {
  59   3                  return 0; // åˆå§‹åŒ–å¤±è´¥
  60   3              }
  61   2          }
  62   1          return 1; // åˆå§‹åŒ–æˆåŠŸ
  63   1      }
  64          
  65          /*******************************************************************************
  66           * å‡½ æ•° å         : Ds18b20WriteByte
  67           * å‡½æ•°åŠŸèƒ½      : å‘18B20å†™å…¥ä¸€ä¸ªå­—èŠ‚
  68           * è¾“    å…¥         : æ— 
  69           * è¾“    å‡º         : æ— 
  70           *******************************************************************************/
  71          
  72          void Ds18b20WriteByte(uchar dat)
  73          {
  74   1          uint i, j;
  75   1      
  76   1          for (j = 0; j < 8; j++)
  77   1          {
  78   2              DSPORT = 0;          // æ¯å†™å…¥ä¸€ä½æ•°æ®ä¹‹å‰å…ˆæŠŠæ€»çº¿æ‹‰ä½1us
  79   2              i++;                 // ç­‰ä»·äºå»¶æ—¶1us
  80   2              DSPORT = dat & 0x01; // ç„¶åå†™å…¥ä¸€ä¸ªæ•°æ®ï¼Œä»æœ€ä½ä½å¼€å§‹
  81   2              i = 6;
  82   2              while (i--)
  83   2                  ;       // å»¶æ—¶68usï¼ŒæŒç»­æ—¶é—´æœ€å°‘60us
  84   2              DSPORT = 1; // ç„¶åé‡Šæ”¾æ€»çº¿ï¼Œè‡³å°‘1usç»™æ€»çº¿æ¢å¤æ—¶é—´æ‰èƒ½æ¥ç€å†™å…¥ç¬¬äºŒä¸ªæ•°å€
             -¼
  85   2              dat >>= 1;
  86   2          }
  87   1      }
  88          /*******************************************************************************
  89           * å‡½ æ•° å         : Ds18b20ReadByte
  90           * å‡½æ•°åŠŸèƒ½      : è¯»å–ä¸€ä¸ªå­—èŠ‚
  91           * è¾“    å…¥         : æ— 
  92           * è¾“    å‡º         : æ— 
  93           *******************************************************************************/
  94          
  95          uchar Ds18b20ReadByte()
  96          {
  97   1          uchar byte, bi;
  98   1          uint i, j;
  99   1          for (j = 8; j > 0; j--)
 100   1          {
 101   2              DSPORT = 0; // å…ˆå°†æ€»çº¿æ‹‰ä½1us
 102   2              i++;
 103   2              DSPORT = 1; // ç„¶åé‡Šæ”¾æ€»çº¿
 104   2              i++;
 105   2              i++; // å»¶æ—¶6usç­‰å¾…æ•°æ®ç¨³å®š
 106   2              // æ¥æ”¶æ•°æ®: é«˜ä½ --> ä½ä½
 107   2              bi = DSPORT; // è¯»å–æ•°æ®ï¼Œä»æœ€ä½ä½å¼€å§‹è¯»å–
 108   2              /*å°†byteå·¦ç§»ä¸€ä½ï¼Œç„¶åä¸ä¸Šå³ç§»7ä½åçš„biï¼Œæ³¨æ„ç§»åŠ¨ä¹‹åç§»æ‰é‚£ä½è¡¥0ã€‚*/
 109   2              byte = (byte >> 1) | (bi << 7);
 110   2              i = 4; // è¯»å–å®Œä¹‹åç­‰å¾…48uså†æ¥ç€è¯»å–ä¸‹ä¸€ä¸ªæ•°
 111   2              while (i--)
 112   2                  ;
 113   2          }
 114   1          return byte;
 115   1      }
C51 COMPILER V9.54   DS18B20                                                               06/03/2024 17:19:36 PAGE 3   

 116          /*******************************************************************************
 117           * å‡½ æ•° å         : Ds18b20ChangTemp
 118           * å‡½æ•°åŠŸèƒ½      : è®©18b20å¼€å§‹è½¬æ¢æ¸©åº¦
 119           * è¾“    å…¥         : æ— 
 120           * è¾“    å‡º         : æ— 
 121           *******************************************************************************/
 122          
 123          void Ds18b20ChangTemp()
 124          {
 125   1          Ds18b20Init();
 126   1          Delay1ms(1);
 127   1          Ds18b20WriteByte(0xcc); // è·³è¿‡ROMæ“ä½œå‘½ä»¤ï¼šå¿½ç•¥ 64 ä½ ROM åœ°å€ï¼Œç›´æ¥å‘ DS1820 å‘æ¸©å
             -º¦å˜æ¢å‘½ä»¤
 128   1          Ds18b20WriteByte(0x44); // æ¸©åº¦è½¬æ¢å‘½ä»¤ï¼šå¯åŠ¨DS1820è¿›è¡Œæ¸©åº¦è½¬æ¢
 129   1          // Delay1ms(100); //ç­‰å¾…è½¬æ¢æˆåŠŸï¼Œè€Œå¦‚æœä½ æ˜¯ä¸€ç›´åˆ·ç€çš„è¯ï¼Œå°±ä¸ç”¨è¿™ä¸ªå»¶æ—¶äº†
 130   1      }
 131          /*******************************************************************************
 132           * å‡½ æ•° å         : Ds18b20ReadTempCom
 133           * å‡½æ•°åŠŸèƒ½      : å‘é€è¯»å–æ¸©åº¦å‘½ä»¤
 134           * è¾“    å…¥         : æ— 
 135           * è¾“    å‡º         : æ— 
 136           *******************************************************************************/
 137          
 138          void Ds18b20ReadTempCom()
 139          {
 140   1      
 141   1          Ds18b20Init();
 142   1          Delay1ms(1);
 143   1          Ds18b20WriteByte(0xcc); // è·³è¿‡ROMæ“ä½œå‘½ä»¤
 144   1          Ds18b20WriteByte(0xbe); // å‘é€è¯»å–æ¸©åº¦å‘½ä»¤ï¼šè¯»å†…éƒ¨RAMä¸­9å­—èŠ‚çš„å†…å®¹
 145   1      }
 146          /*******************************************************************************
 147           * å‡½ æ•° å         : Ds18b20ReadTemp
 148           * å‡½æ•°åŠŸèƒ½      : è¯»å–æ¸©åº¦
 149           * è¾“    å…¥         : æ— 
 150           * è¾“    å‡º         : æ— 
 151           *******************************************************************************/
 152          
 153          int Ds18b20ReadTemp()
 154          {
 155   1          int temp = 0;
 156   1          uchar tmh, tml;
 157   1          Ds18b20ChangTemp();      // å…ˆå†™å…¥è½¬æ¢å‘½ä»¤
 158   1          Ds18b20ReadTempCom();    // ç„¶åç­‰å¾…è½¬æ¢å®Œåå‘é€è¯»å–æ¸©åº¦å‘½ä»¤
 159   1          tml = Ds18b20ReadByte(); // è¯»å–æ¸©åº¦å€¼å…±16ä½ï¼Œå…ˆè¯»ä½å­—èŠ‚
 160   1          tmh = Ds18b20ReadByte(); // å†è¯»é«˜å­—èŠ‚
 161   1          temp = tmh;
 162   1          temp <<= 8;
 163   1          temp |= tml;
 164   1          return temp;
 165   1      }
 166          
 167          /*******************************************************************************
 168           * å‡½ æ•° å         : datapros()
 169           * å‡½æ•°åŠŸèƒ½      : æ¸©åº¦è¯»å–å¤„ç†è½¬æ¢å‡½æ•°
 170           * è¾“    å…¥         : temp
 171           * è¾“    å‡º         : æ— 
 172           *******************************************************************************/
 173          
 174          void datapros(int temp)
 175          {
 176   1          float tp;
C51 COMPILER V9.54   DS18B20                                                               06/03/2024 17:19:36 PAGE 4   

 177   1          if (temp < 0) // å½“æ¸©åº¦å€¼ä¸ºè´Ÿæ•°
 178   1          {
 179   2              DisplayData[0] = 0x40; //  ç¬¬ä¸€ä¸ªæ•°ç ç®¡ æ˜¾ç¤º -
 180   2              // å› ä¸ºè¯»å–çš„æ¸©åº¦æ˜¯å®é™…æ¸©åº¦çš„è¡¥ç ï¼Œæ‰€ä»¥å‡1ï¼Œå†å–åæ±‚å‡ºåŸç 
 181   2              temp = temp - 1;
 182   2              temp = ~temp;
 183   2              tp = temp;
 184   2              temp = tp * 0.0625 * 100 + 0.5;
 185   2              // ç•™ä¸¤ä¸ªå°æ•°ç‚¹å°±*100ï¼Œ+0.5æ˜¯å››èˆäº”å…¥ï¼Œå› ä¸ºCè¯­è¨€æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´å‹çš„æ—¶å€
             -™æŠŠå°æ•°ç‚¹
 186   2              // åé¢çš„æ•°è‡ªåŠ¨å»æ‰ï¼Œä¸ç®¡æ˜¯å¦å¤§äº0.5ï¼Œè€Œ+0.5ä¹‹åå¤§äº0.5çš„å°±æ˜¯è¿›1äº†ï¼Œå°
             -äº0.5çš„å°±
 187   2              // ç®—åŠ ä¸Š0.5ï¼Œè¿˜æ˜¯åœ¨å°æ•°ç‚¹åé¢ã€‚
 188   2          }
 189   1          else
 190   1          {
 191   2              DisplayData[0] = 0x00;
 192   2              tp = temp; // å› ä¸ºæ•°æ®å¤„ç†æœ‰å°æ•°ç‚¹æ‰€ä»¥å°†æ¸©åº¦èµ‹ç»™ä¸€ä¸ªæµ®ç‚¹å‹å˜é‡
 193   2              // å¦‚æœæ¸©åº¦æ˜¯æ­£çš„é‚£ä¹ˆï¼Œé‚£ä¹ˆæ­£æ•°çš„åŸç å°±æ˜¯è¡¥ç å®ƒæœ¬èº«
 194   2              temp = tp * 0.0625 * 100 + 0.5;
 195   2              // ç•™ä¸¤ä¸ªå°æ•°ç‚¹å°±*100ï¼Œ+0.5æ˜¯å››èˆäº”å…¥ï¼Œå› ä¸ºCè¯­è¨€æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´å‹çš„æ—¶å€
             -™æŠŠå°æ•°ç‚¹
 196   2              // åé¢çš„æ•°è‡ªåŠ¨å»æ‰ï¼Œä¸ç®¡æ˜¯å¦å¤§äº0.5ï¼Œè€Œ+0.5ä¹‹åå¤§äº0.5çš„å°±æ˜¯è¿›1äº†ï¼Œå°
             -äº0.5çš„å°±
 197   2              // ç®—åŠ ä¸Š0.5ï¼Œè¿˜æ˜¯åœ¨å°æ•°ç‚¹åé¢ã€‚
 198   2          }
 199   1          DisplayData[1] = smgduan[temp / 10000];             // ç™¾ä½
 200   1          DisplayData[2] = smgduan[temp % 10000 / 1000];      // åä½
 201   1          DisplayData[3] = smgduan[temp % 1000 / 100] | 0x80; // ä¸ªä½
 202   1      
 203   1          DisplayData[4] = smgduan[temp % 100 / 10]; // ååˆ†ä½
 204   1          DisplayData[5] = smgduan[temp % 100 % 10]; // ç™¾åˆ†ä½
 205   1      }
 206          
 207          void TestDS18B20()
 208          {
 209   1          while (1)
 210   1          {
 211   2              datapros(Ds18b20ReadTemp()); // æ•°æ®å¤„ç†å‡½æ•°
 212   2              DigDisplay(DisplayData);     // æ•°ç ç®¡æ˜¾ç¤ºå‡½æ•°
 213   2          }
 214   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    548    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
